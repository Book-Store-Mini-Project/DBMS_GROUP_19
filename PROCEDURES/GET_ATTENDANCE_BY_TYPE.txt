DELIMITER //

CREATE PROCEDURE get_attendance_by_type(
    IN p_course_code VARCHAR(20),
    IN p_type ENUM('theory','practical','combined')
)
BEGIN
    SELECT
        ar.reg_num,
        s.course_code,
        COUNT(ar.record_id) AS total_sessions,
        SUM(CASE WHEN ar.status = 'Present' THEN 1 ELSE 0 END) AS present_count,
        SUM(CASE WHEN ar.status = 'Absent' THEN 1 ELSE 0 END) AS absent_count,
        SUM(CASE WHEN ar.status = 'Medical' THEN 1 ELSE 0 END) AS medical_count,
        ROUND(
            (SUM(CASE WHEN ar.status IN ('Present','Medical') THEN 1 ELSE 0 END) / COUNT(ar.record_id)) * 100,
            2
        ) AS attendance_percentage
    FROM attendance_records ar
    JOIN attendance_session s ON ar.session_id = s.session_id
    WHERE s.course_code = p_course_code
      AND (
          (p_type = 'theory' AND s.session_type = 'lecture') OR
          (p_type = 'practical' AND s.session_type = 'practical') OR
          (p_type = 'combined')
      )
    GROUP BY ar.reg_num, s.course_code
    ORDER BY ar.reg_num;
END //

DELIMITER ;


