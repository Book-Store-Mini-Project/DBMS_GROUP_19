CREATE VIEW student_course_attendance_summary AS
SELECT
    ar.reg_num,
    s.course_code,
    COUNT(ar.record_id) AS total_sessions,
    SUM(CASE WHEN ar.status = 'Present' THEN 1 ELSE 0 END) AS present_count,
    SUM(CASE WHEN ar.status = 'Absent' THEN 1 ELSE 0 END) AS absent_count,
    SUM(CASE WHEN ar.status = 'Medical' THEN 1 ELSE 0 END) AS medical_count,
    ROUND(
        (SUM(CASE WHEN ar.status IN ('Present','Medical') THEN 1 ELSE 0 END) / COUNT(ar.record_id)) * 100,
        2
    ) AS attendance_percentage,
    CASE
        WHEN ROUND(
            (SUM(CASE WHEN ar.status IN ('Present','Medical') THEN 1 ELSE 0 END) / COUNT(ar.record_id)) * 100,
            2
        ) >= 80 THEN 'Eligible'
        ELSE 'Not Eligible'
    END AS eligibility
FROM attendance_records ar
JOIN attendance_session s ON ar.session_id = s.session_id
GROUP BY ar.reg_num, s.course_code
ORDER BY ar.reg_num, s.course_code;
